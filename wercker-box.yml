name: exchangegroup
version: 0.0.3
inherits: wercker/ubuntu12.04-ruby2.0.0@0.3.0
type: main
platform: ubuntu@12.04
description: Ruby 2, node.js, sphinx, phantomjs, karma, geocitylite.
packages:
  - mysql@5.6
  - nodejs@0.10.17
  - sphinxsearch@2.0.8
  - phantomjs@1.9.1
keywords:
  - mysql
  - nodejs
  - sphinxsearch
  - karma
script: |
  # percona apt
  sudo apt-key adv --keyserver keys.gnupg.net --recv-keys 1C4CBDCDCD2EFD2A

  echo "deb http://repo.percona.com/apt precise main" > source
  echo "deb-src http://repo.percona.com/apt precise main" >> source
  sudo cp source /etc/apt/sources.list.d/percona.list

  sudo apt-get update

  # percona
  sudo apt-get remove mysql-client mysql-client-5.5 mysql-client-core-5.5
  sudo rm -rf /etc/mysql
  sudo apt-get install percona-server-5.5 percona-server-client-5.5

  # mysql ramdisk
  sudo /etc/init.d/mysql stop
  sudo mkdir /tmp/ramdisk
  sudo mount -t tmpfs -o size=256M tmpfs /tmp/ramdisk/

  # Move MySQL data
  sudo mv /var/lib/mysql /tmp/ramdisk/mysql
  sudo ln -s /tmp/ramdisk/mysql/ /var/lib/mysql

  # Update permissions
  sudo chmod -R 700 /var/lib/mysql
  sudo chown -R mysql:mysql /var/lib/mysql

  sudo /etc/init.d/mysql restart
  sudo update-rc.d mysql defaults

  # node.js
  export NODEVERSION=0.10.17
  sudo apt-get install -y wget build-essential
  cd $HOME
  mkdir nodeinstall
  cd nodeinstall
  wget http://nodejs.org/dist/v$NODEVERSION/node-v$NODEVERSION.tar.gz
  tar xzvf node-v$NODEVERSION.tar.gz
  cd node-v$NODEVERSION
  ./configure
  make
  sudo make install
  cd $HOME
  rm -fr nodeinstall
  node -v

  # sphinx
  wget http://sphinxsearch.com/files/sphinxsearch_2.0.8-release-0ubuntu11~precise1_amd64.deb
  sudo dpkg -i sphinxsearch_2.0.8-release-0ubuntu11~precise1_amd64.deb

  # phantomjs
  wget https://phantomjs.googlecode.com/files/phantomjs-1.9.2-linux-x86_64.tar.bz2
  tar xfj phantomjs-1.9.2-linux-x86_64.tar.bz2
  sudo cp phantomjs-1.9.2-linux-x86_64/bin/phantomjs /usr/local/bin

  # bundler 1.5 rc
  sudo gem install bundler --pre -v 1.5.0.rc.1

  # karma
  sudo apt-get install -y libqt4-dev qt4-qmake
  sudo npm install -g karma

  # GeoCityLite database
  curl -O http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz
  gunzip GeoLiteCity.dat.gz
  sudo mkdir -p /usr/share/GeoIP
  sudo cp GeoLiteCity.dat /usr/share/GeoIP
